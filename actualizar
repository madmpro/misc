#!/usr/bin/env bash
# Made by Sinfallas <sinfallas@yahoo.com>
# Licence: GPL-2
set -euo pipefail
LC_ALL=C
SECONDS=0
mylog="/var/log/$(basename $0).log"
LOCKFILE="/tmp/$(basename $0)_$(whoami)"
LOCKFD="150"

echo "$BASHPID" > /run/"$(basename $0)".pid
exec 2>/var/log/$(basename $0).log

function clean_1() {
	rm -f /run/$(basename $0).pid
	rm -f /tmp/$(basename $0)_$(whoami)
	killall -q apt dpkg
	rm -f /var/lib/dpkg/lock
	rm -f /var/lib/apt/lists/lock
	rm -rf /tmp/*
	rm -rf /var/tmp/*
}

trap "clean_1; exit" 0 1 2 3 15
clear
if [[ "$EUID" != "0" ]]; then
	echo -e "\e[00;31mERROR: Debes ser root.\e[00m"
	exit 1
fi

function lock() {
	echo {LOCKFD}>$LOCKFILE
	flock -n $LOCKFD
}

function exit_error() {
	echo -e "\e[00;31mYa hay una instancia en ejecuciÃ³n. Saliendo\e[00m"
	exit 1
}

lock || exit_error

if ! [[ -f /usr/bin/deborphan ]] || [[ $(dpkg --get-selections | grep -w "deborphan" | awk '{print $1}' | head -1) != deborphan ]]; then
	apt -q update
	apt -qy install deborphan
fi

echo "Iniciando Actualizacion $(date +%d/%m/%Y)" >> $mylog
echo -e "\e[00;1;92mIniciando Actualizacion\e[00m"
rm -f /var/lib/dpkg/lock
rm -f /var/lib/apt/lists/lock
apt -q update
apt-fast -y --allow-unauthenticated dist-upgrade
echo -e "\e[00;1;92mLimpiar\e[00m"
apt -y autoremove
apt autoclean
apt clean
echo -e "\e[00;1;92mDeborphan\e[00m"
apt -y purge $(deborphan --libdevel) $(deborphan --find-config) $(deborphan)
echo -e "\e[00;1;92mGrub\e[00m"
update-grub2
echo -e "\e[00;1;92mPrelink\e[00m"
prelink -amR
history -c
echo "Finalizado $(date +%d/%m/%Y)" >> $mylog
echo "Duracion $SECONDS" >> $mylog
echo "" >> $mylog
echo -e "\e[00;1;92mFinalizado...\e[00m"
exit 0
