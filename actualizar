#!/usr/bin/env bash
# Made by Sinfallas <sinfallas@yahoo.com>
# Licence: GPL-2
set -eu
LC_ALL=C
IFS=" "
SECONDS=0
fecha2=$(date +%d/%m/%Y-%I:%M)
mylog="/var/log/$(basename $0).log"
LOCKFILE="/tmp/$(basename $0)_$(whoami)"
LOCKFD="150"

echo "$BASHPID" > /run/"$(basename $0)".pid
exec 2>>$mylog

function clean_1() {
	rm -f /run/$(basename $0).pid
	rm -f /tmp/$(basename $0)_$(whoami)
	rm -f /var/lib/dpkg/lock
	rm -f /var/lib/apt/lists/lock
	rm -rf /tmp/*
	rm -rf /var/tmp/*
}

trap "clean_1; exit" 0 1 2 3 15

if [[ "$EUID" != "0" ]]; then
	echo -e "\e[00;31mERROR: Debes ser root.\e[00m"
	exit 1
fi

function lock() {
	echo {LOCKFD}>$LOCKFILE
	flock -n $LOCKFD
}

function exit_error() {
    echo "ERROR: Ya hay una instancia en ejecución. Saliendo $fecha2" >> $mylog
	echo -e "\e[00;31mYa hay una instancia en ejecución. Saliendo\e[00m"
	exit 1
}

lock || exit_error
clear

if ! [[ -f /usr/bin/deborphan ]] || [[ $(dpkg --get-selections | grep -w "deborphan" | awk '{print $1}' | head -1) != deborphan ]]; then
	apt -q update
	apt -qy install deborphan
fi

echo "Iniciando Actualizacion $fecha2" >> $mylog
rm -f /var/lib/dpkg/lock
rm -f /var/lib/apt/lists/lock
apt -q update
apt -y --allow-unauthenticated dist-upgrade
apt -y autoremove
apt autoclean
apt clean
apt -y purge $(deborphan --libdevel) $(deborphan --find-config) $(deborphan)
update-grub2
prelink -amR
history -c
echo "Finalizado $fecha2" >> $mylog
echo "Duracion $SECONDS segundos." >> $mylog
echo "" >> $mylog
echo -e "\e[00;1;92mFinalizado...\e[00m"
exit 0