#!/usr/bin/env bash
# Made by Sinfallas <sinfallas@yahoo.com>
# Licence: GPL-2
set -euo pipefail
LC_ALL=C
SECONDS=0
mylog="/var/log/$(basename $0).log"
LOCKFILE="/tmp/$(basename $0)_$(whoami)"
LOCKFD="150"
lock1="/var/lib/dpkg/lock"
lock2="/var/lib/apt/lists/lock"
quien=$(who | cut -d' ' -f1 | sort | uniq)
gdonde="/home/$quien/.gnupg/gpg.conf"
echo $BASHPID > /run/"$(basename $0)".pid
exec 2>>$mylog

function clean_1() {
	rm -f /run/$(basename $0).pid
	rm -f $LOCKFILE
	killall -q apt dpkg
	rm -f $lock1
	rm -f $lock2
	rm -rf /tmp/*
	rm -rf /var/tmp/*
	dpkg --configure -a
}

trap "clean_1; exit" 0 1 2 3 15
clear
if [[ "$EUID" != "0" ]]; then
	echo -e "\e[00;31mERROR: Debes ser root.\e[00m"
	exit 1
fi

function lock() {
	echo {LOCKFD}>$LOCKFILE
	flock -n $LOCKFD
}

function exit_error() {
	echo -e "\e[00;31mYa hay una instancia en ejecuciÃ³n. Saliendo\e[00m"
	exit 1
}

lock || exit_error

if ! [[ -f /usr/bin/deborphan ]] || [[ $(dpkg --get-selections | grep -w "deborphan" | awk '{print $1}' | head -1) != deborphan ]]; then
	apt -q update
	apt -qy install deborphan
fi

echo "Iniciando Actualizacion $(date +%d/%m/%Y)" >> $mylog
echo -e "\e[00;1;92mIniciando Actualizacion\e[00m"
rm -f $lock1
rm -f $lock2
apt -q update
apt-fast -y --allow-unauthenticated dist-upgrade
echo -e "\e[00;1;92mLimpiar\e[00m"
apt -y autoremove
apt autoclean
apt clean
rm -rf /root/.local/share/Trash/*
rm -rf /home/*/.local/share/Trash/*
echo -e "\e[00;1;92mDeborphan\e[00m"
apt -y remove --purge $(deborphan --libdevel) $(deborphan --find-config) $(deborphan)
echo -e "\e[00;1;92mInitramfs\e[00m"
update-initramfs -k all -u
echo -e "\e[00;1;92mGrub\e[00m"
update-grub2
echo -e "\e[00;1;92mPrelink\e[00m"
prelink -amR
history -c
echo -e "\e[00;1;92mLimpiando servicios y personalizando\e[00m"
systemctl disable ModemManager.service
systemctl disable avahi-daemon.service
systemctl disable speech-dispatcher.service
systemctl disable pppd-dns.service
systemctl disable snapd.service
systemctl disable snapd.seeded.service
systemctl disable unattended-upgrades
systemctl disable nmbd
systemctl disable apt-daily
systemctl disable libvirtd
systemctl disable clamav-freshclam
gsettings set org.gnome.shell.extensions.dash-to-dock click-action 'minimize'
chown $quien:$quien $gdonde
chmod -Rv 700 /home/$quien/.ssh
chmod -Rv 700 /home/$quien/.bazaar
chmod -Rv 700 /home/$quien/.gnupg
echo "Finalizado $(date +%d/%m/%Y)" >> $mylog
echo "Duracion $SECONDS segundos" >> $mylog
echo "Duracion $SECONDS segundos"
echo "" >> $mylog
echo -e "\e[00;1;92mFinalizado...\e[00m"
exit 0
